name: 'Deploy wiki'
on:
  push:
    branches:
      - master
jobs:
  deploy_wiki:
    name: 'Deploy wiki'
    if: startsWith(github.repository, 'codeoverflow-org') # don't run this in forks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/checkout@v2
        with:
          repository: codeoverflow-org/chatoverflow-gh-pages
          path: gh-pages
      - uses: actions/setup-python@v1
        with:
          python-version: 3.8
      - name: Install mkdocs with extensions, themes and plugins
        run: |
          pip install mkdocs
          pip install mkdocs-material
          pip install pymdown-extensions
          pip install pygments
          pip install pygments
          pip install mkdocs-abs-rel-plugin
          pip install mkdocs-git-revision-date-localized-plugin
      - name: Build dark-theme.css
        uses: gha-utilities/sass-build@v0.1.0
        with:
          source: docs/stylesheets/dark-theme.scss
          destination: docs/stylesheets/dark-theme.css
      - name: Build custom-header.css
        uses: gha-utilities/sass-build@v0.1.0
        with:
          source: docs/stylesheets/custom-header.scss
          destination: docs/stylesheets/custom-header.css
      - name: 'Fix links' #strip '/docs' from all relative links
        run: |
          find . -type f -name "*.md" -exec sed -i 's:\[\([^][\n]*\)\](/docs/\([^ \n()]\+\)):[\1](/\2):g' {} +
          find . -type f -name "*.md" -exec sed -i 's:<img\([^>\n]* src *= *\)"/docs/\([^ >\n]\+\)"\([^>\n]*\)>:<img\1"/\2"\3>:g' {} +
      - name: Build docs
        run: |
          mkdocs build --clean
      - name: Copy java & scaladoc
        run: |
          cp -r gh-pages/code/ site/code/
          cp gh-pages/readme.md site/readme.md
          cp gh-pages/CNAME site/CNAME
      - name: Deploy
        uses: docker://peaceiris/gh-pages:v2
        env:
          PERSONAL_TOKEN: ${{ secrets.GH_PAT }}
          PUBLISH_DIR: ./site
          EXTERNAL_REPOSITORY: codeoverflow-org/chatoverflow-gh-pages
          PUBLISH_BRANCH: master

# This file is not included in the wiki.
